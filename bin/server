#!/usr/bin/env node
'use strict';

let cluster = require('cluster');
let path = require('path');
let _ = require('lodash');
let amqp = require('amqp');
let config = require('../config').get('/queues');

if(cluster.isMaster) {
    console.log('Starting cluster coordinator (' + (process.env.NODE_ENV || 'dev') + ')');
    cluster.fork({
        task: 'queue-processor'
    });
    cluster.fork({
        task: 'www'
    });

    cluster.on('exit', (worker, code, signal) => {
        if(!worker.suicide) {
            console.log('worker (%s) died (reason: %s), , restarting...',
                worker.process.env['task'] || 'www',
                signal || code);

            cluster.fork({
                task: worker.process.env['task'] || 'www'
            });
        }
    });
}
else {
    var task = process.env.task || 'www';
    try {
        require('../server/' + task)();
    }
    catch(err) {
        console.log('Uncaught exception (task: %s): %s', task, err);
    }
}
